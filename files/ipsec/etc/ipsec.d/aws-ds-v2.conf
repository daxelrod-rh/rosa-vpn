# ensure that config exists
sudo tee /etc/ipsec.conf >/dev/null <<'EOF'
config setup
    uniqueids=yes
include /etc/ipsec.d/*.conf
EOF

# ensure that the directory exists
sudo install -d -m 755 /etc/ipsec.d

# libreswan config 
sudo tee /etc/ipsec.d/aws.conf >/dev/null <<'EOF'
conn %default
    keyexchange=ikev2
    authby=secret
    type=tunnel
    left=%defaultroute
    leftid=44.212.130.162
    leftsubnet=192.168.1.0/24
    rightsubnet=10.10.0.0/16
    ike=aes128-sha1;modp2048
    esp=aes128-sha1;modp2048
    ikelifetime=28800s
    salifetime=3600s
    dpddelay=10
    retransmit-timeout=60
    auto=ignore

conn aws-tun-1
    right=18.204.200.100
    auto=start

conn aws-tun-2
    right=52.20.28.136
    auto=start
EOF

# ensure the secrets include is in place 
sudo cp -a /etc/ipsec.secrets{,.bak} 2>/dev/null || true
echo 'include /etc/ipsec.d/*.secrets' | sudo tee /etc/ipsec.secrets >/dev/null
sudo chown root:root /etc/ipsec.secrets && sudo chmod 600 /etc/ipsec.secrets

# restore SELinux labels (if enforcing)
sudo restorecon -v /etc/ipsec.conf /etc/ipsec.d/aws.conf /etc/ipsec.secrets /etc/ipsec.d/aws.secrets 2>/dev/null || true

# restart and bring up
sudo systemctl restart ipsec
sudo ipsec up aws-tun-1
sudo ipsec up aws-tun-2

# show status
sudo ipsec status | sed -n '/Connection list:/,$p' | sed -n '1,160p'
sudo journalctl -u ipsec -n 60 --no-pager

# optional: make tun-2 standby
sudo sed -i '/^conn aws-tun-2$/,/^conn/{s/^ *auto=start/    auto=ignore/}' /etc/ipsec.d/aws.conf
sudo systemctl restart ipsec
